(function(a) {
	var isfullwithMenu;
    a.fn.nthTabs = function(c) {
        var h = this;
        var g = {
            allowClose: true,
            active: false,
            rollWidth: h.width() - 160,
        };
        var e = a.extend({},
        g, c);
        //修改：园区统一样式
        var d = '<div class="page-tabs">' +
            // '<a href="#" class="roll-nav roll-nav-left"><span class="fa fa-backward"></span></a>' +
            '<div class="content-tabs"><div class="content-tabs-container" id="tabContent"><ul class="nav nav-tabs" id="tabs-Cont"></ul></div></div>' +
            // '<a href="#" class="roll-nav roll-nav-right"><span class="fa fa-forward"></span></a>' +
            // '<a href="#" class="roll-nav full-div" id="fullScreen"><span class="fa fa-arrows-alt"></span></a>' +
            '<div class="dropdown roll-nav right-nav-list"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="fa fa-chevron-down"></span></a><ul class="dropdown-menu pull-right"><li><a href="#" class="tab-location">\u5b9a\u4f4d\u5f53\u524d\u9009\u9879\u5361</a></li><li><a href="#" class="tab-close-current">\u5173\u95ed\u5f53\u524d\u9009\u9879\u5361</a></li><li role="separator" class="divider"></li><li><a href="#" class="tab-close-other">\u5173\u95ed\u5176\u4ed6\u9009\u9879\u5361</a></li><li><a href="#" class="tab-close-all">\u5173\u95ed\u5168\u90e8\u9009\u9879\u5361</a></li></ul></div></div><div class="issp-tab-content" style="height:95%;width: 100%;overflow-y: auto;overflow-x: hidden;" id="contentView"></div>';
        var b = {
            init: function() {
                h.html(d);
                b.listen();
            },
            listen: function() {
                f.onTabClose().onTabRollLeft().onTabRollRight().onTabList().onTabCloseOpt().onTabCloseAll().onTabCloseOther().onLocationTab().onFullScreen()
            },
            getAllTabWidth: function() {
                var i = 0;
                h.find(".nav-tabs li").each(function() {
                    i += parseFloat(a(this).width())
                });
                return i
            },
            getMarginStep: function() {
                return e.rollWidth / 2;
            },
            getActiveId: function() {
                return h.find('li[class="active"]').find("a").attr("href").replace("#", "");
            },
            getActiveName: function() {
            	return h.find('li[class="active"]').find("a>span").text();
            },
            getTabList: function() {
                var i = [];
                h.find(".nav-tabs li a").each(function() {
                    i.push({
                        id: a(this).attr("href"),
                        title: a(this).children("span").html()
                    })
                });
                return i;
            },
            addTab: function(j) {
                var k = [];
                isfullwithMenu = j.fullwithMenu;
                var m = j.active == undefined ? e.active: j.active;
                var i = j.allowClose == undefined ? e.allowClose: j.allowClose;
                m = m ? "active": "";
                sessionStorage.setItem(j.id, isfullwithMenu);
                k.push('<li role="presentation" class="' + m + '" showLeftMenus="' + j.showLeftMenus + '" moduleId="' + j.moduleId + '" menuId="' + j.id  + '">');
                k.push('<a href="#' + j.id + '" data-toggle="tab">');
                k.push("<span>" + j.title + "</span>");
                i ? k.push('<i class="fa fa-close tab-close"></i>') : "";
                k.push("</a>");
                k.push("</li>");
                h.find(".nav-tabs").append(k.join(""));
                h.find(".issp-tab-content").append(j.content);
                return b;
            },
            locationTab: function(j) {
                j = j == undefined ? b.getActiveId() : j;
                j = j.indexOf("#") > -1 ? j: "#" + j;
                var m = h.find("[href='" + j + "']");
                var l = 0;
                m.parent().prevAll().each(function() {
                    l += a(this).width();
                });
                var i = m.parent().parent().parent();
                if (l <= e.rollWidth * 0.7) {
                    margin_left_total = 40;
                } else {
                    if (l <= e.rollWidth) {
                        margin_left_total = 40 - e.rollWidth / 2;
                    } else {
                        var k = l + m.parent().width() - (Math.floor(l / e.rollWidth) * e.rollWidth);
                        if (k <= e.rollWidth * 0.7) {
                            margin_left_total = 40 - Math.floor(l / e.rollWidth) * e.rollWidth;
                        } else {
                            margin_left_total = 40 - Math.floor(l / e.rollWidth) * e.rollWidth - e.rollWidth / 2;
                        }
                    }
                }
                i.css("margin-left", margin_left_total);
                return b;
            },
            delTab: function(j) {
                j = j == undefined ? b.getActiveId() : j;
                j = j.indexOf("#") > -1 ? j: "#" + j;
                var tabcolseable = sessionStorage.getItem(j+"-isspTabCloseable");//如 #204-isspTabCloseable
                if(tabcolseable=="false"){
                	swal({ 
  	            	  title: sessionStorage.getItem(j+"-isspTabCloseableMsg"), 
  	            	  text: "", 
  	            	  type: "warning",
  	            	  showCancelButton: true, 
  	            	  confirmButtonColor: "#1ab394",
  	            	  confirmButtonText: "关闭", 
  	            	  cancelButtonText: "取消"
  	            	},function(isConfirm){ 
  	            	  if (isConfirm) {
  	            	    sessionStorage.setItem(j+"-isspTabCloseable",null);
  	            	    b.delisspTab(j);
  	            	    $(window).trigger('resize');
  	            	  } else {
  	            		return false;
  	            	  } 
  	            	});
                }else{
                	b.delisspTab(j);
                }
            },
            delisspTab: function(j) {
            	var k = h.find("[href='" + j + "']");
                var canClose = k.find(".tab-close").length;
                if (canClose == 0) return false;
                if (k.parent().attr("class") == "active") {
                    var i = k.parent().next();
                    var l = a(j).next();
                    if (i.length < 1) {
                        i = k.parent().prev();
                        l = a(j).prev();
                    }
                    i.addClass("active");
                    l.addClass("active");
                }
                sessionStorage.setItem(k[0].hash, null);
                k.parent().remove();
                a(j).remove();
                isspGlobal.getLeftMeuns(i);
                return b;
            },
            delOtherTab: function() {
                var delTabs = h.find(".nav-tabs li").not('[class="active"]');
                for (var i = 0; i < delTabs.length; i++) {
                    var tabName = delTabs[i].childNodes[0].hash;
                    //b.setActTab(tabName);
                    b.delTab(tabName);
                }
                $(window).trigger('resize');
                return b;
            },
            delAllTab: function() {
	        	var allTab = h.find(".nav-tabs li a");
	            for (var i = 0; i < allTab.length; i++) {
	               var tabName = allTab[i].hash;
	               b.delTab(tabName)
	            }
	            $(window).trigger('resize');
	            return b;
            },
            delAllTabIgnoreCloseable: function() {
                h.find(".nav-tabs li").remove();
                h.find(".issp-tab-content div").remove();
                return b;
            },
            setActTab: function(i) {
                i = i == undefined ? b.getActiveId() : i;
                i = i.indexOf("#") > -1 ? i: "#" + i;
                h.find(".active").removeClass("active");
                h.find("[href='" + i + "']").parent().addClass("active");
                h.find(i).addClass("active");
                return b;
            },
        };
        var f = {
            onLocationTab: function() {
                h.on("click", ".tab-location",
                function() {
                    b.locationTab();
                });
                return f;
            },
            onTabClose: function() {
                h.on("click", ".tab-close",
                function() {
                    var i = a(this).parent().attr("href");
                    b.delTab(i);
                    b.locationTab();
                });
                return f;
            },
            onTabCloseOpt: function() {
                h.on("click", ".tab-close-current",
                function() {
                    b.delTab();
                    b.locationTab();
                });
                return f;
            },
            onTabCloseOther: function() {
                h.on("click", ".tab-close-other",
                function() {
                    b.delOtherTab();
                    b.locationTab();
                });
                return f;
            },
            onTabCloseAll: function() {
                h.on("click", ".tab-close-all",
                function() {
                    b.delAllTab();
                    b.locationTab();
                });
                return f;
            },
            onTabRollLeft: function() {
                h.on("click", ".roll-nav-left",
                function() {
                	e.rollWidth = h.width() - 160;
                    /*if (b.getAllTabWidth() <= e.rollWidth) {
                        return false
                    }*/
                    var i = a(this).parent().find(".content-tabs-container");
                    var j = i.css("marginLeft").replace("px", "");
                    var k = parseFloat(j) + b.getMarginStep() + 40;
                    i.css("margin-left", k > 40 ? 40 : k)
                });
                return f;
            },
            onTabRollRight: function() {
                h.on("click", ".roll-nav-right",
                function() {
                	e.rollWidth = h.width() - 160;
                    /*if (b.getAllTabWidth() <= e.rollWidth) {
                        return false
                    }*/
                    var i = a(this).parent().find(".content-tabs-container");
                    var j = i.css("marginLeft").replace("px", "");
                    var k = parseFloat(j) - b.getMarginStep();
                    if (b.getAllTabWidth() - Math.abs(j) <= e.rollWidth) {
                        return false
                    }
                    i.css("margin-left", k)
                });
                return f;
            },
            onFullScreen: function() {
            	h.on("click", ".full-div",
            	function() {
            		var activeId = b.getActiveId();
            		//0:带导航区域全屏;1:内容区域全屏（包括Tab导航，且不含左侧菜单）；2：只显示内容区域
            		isfullwithMenu = sessionStorage.getItem(activeId);
            		var isfull = sessionStorage.getItem("isFullScreen");
            		if(isfull == "yes"){
            			exitFullscreen();
            			$("#contentView").css("height","95%");
            		}else{
            			if(isfullwithMenu=="0" || isfullwithMenu == null){
            				$("#contentView").css("height","95%");
            				fullscreen();
            			}else if(isfullwithMenu=="1"){
            				$("#contentView").css("height","95%");
            				fullscreen($("#tabs")[0]);
            			}else if(isfullwithMenu=="2"){
            				$("#contentView").css("height","100%");
            				fullscreen($("#contentView")[0]);            				
            			}
            		}
            	});
            	return f;
            },
            onTabList: function() {
                h.on("click", ".right-nav-list",
                function() {
                    var i = b.getTabList();
                    var j = [];
                    a.each(i,
                    function(k, l) {
                        j.push('<li class="toggle-tab" data-id="' + l.id + '">' + l.title + "</li>")
                    });
                    h.find(".tab-list").html(j.join(""))
                });
                h.find(".tab-list-scrollbar").scrollbar();
                f.onTabListToggle();
                return f;
            },
            onTabListToggle: function() {
                h.on("click", ".toggle-tab",
                function() {
                    var i = a(this).data("id");
                    b.setActTab(i).locationTab(i)
                });
                return f;
            }
        };
        b.init();
        return b;
    }
})(jQuery);